<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Browser speech recognition</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- <header>
      <h1>Browser speech recognition</h1>
    </header> -->
    <main>
      <button id="button">Start listening</button>
      <select id="voiceSelect"></select>
      <div id="result"></div>
      <p id="message" hidden aria-hidden="true">
        Your browser doesn't support Speech Recognition. Sorry.
      </p>
    </main>
    <!-- <footer>
      <p>Built with üéô by <a href="https://twitter.com/philnash">philnash</a></p>
    </footer> -->
    <script>   
      window.onload = test();

      var phrases = [
        'hey frugtsk√•l',
        '32 bananer'
      ];

      var synth = window.speechSynthesis;
      var voices;
      var utterThis;
      var index;
      var repeat;

      populateVoiceList();
      
      function test(){
        const button = document.getElementById("button");
        const result = document.getElementById("result");
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        console.log("test virker");

        recognition.interimResults = true;
        recognition.maxAlternatives = 1;
        recognition.lang = 'da-DK';

        recognition.start();

        // recognition.onresult = function(event) {
        //   var speechResult = event.results[0].transcript;
        //   result.textContent = speechResult;
        //   console.log(speechResult);
        //   console.log("result:......");
        // }
        var speechResult;
        const onResult = event => {
          result.innerHTML = "";
          for (const res of event.results) {
            const text = document.createTextNode(res[0].transcript);
            const p = document.createElement("p");
            if (res.isFinal) {
              p.classList.add("final");
              console.log('Speech has stopped being detected');
              
              // button.click();
            }
            p.appendChild(text);
            result.appendChild(p);
            
            speechResult = event.results[0][0].transcript.toLowerCase();
            console.log(speechResult, typeof speechResult);
            // if (speechResult.includes("frugtsk√•l")) {
            //   console.log("SUCCESS");
            //   //Tree 1 (user started) 
            //   utterThis = new SpeechSynthesisUtterance("hvad kan jeg g√∏re for dig?");
            //   synth.speak(utterThis);
            // }
          }

          if ((speechResult.includes("tak") || speechResult.includes("Tak") || speechResult.includes("tak.") || speechResult.includes("Tak.")) && repeat == false ) {
            //console.log("SUCCESS");
            //Tree 1 (user started) 
            recognition.stop();
            populateVoiceList();
            utterThis = new SpeechSynthesisUtterance("hvad kan jeg g√∏re for dig?");
            // utterThis.voice = voices[0]
            utterThis.voice = voices[index];
            synth.speak(utterThis);
            //console.log("Frugtsk√•l burde snakke");
            repeat = true;
            console.log(repeat);
            
            //if()addInput().....jeg har k√∏bt xxx, sammeligner med phrases
            //
          }
         // speechResult = "";
          console.log("Speech result:" + speechResult);
        }
        recognition.addEventListener("result", onResult);

        
        recognition.onspeechend = function(){
          recognition.stop();
          console.log("on speech end");
        }
        
        recognition.onsoundstart = function(){
          console.log("on sound start");
        }

        recognition.onend = function (){
          console.log("on End");
          repeat = false;
          setTimeout(test, 1000);
          //test();
          // button.click();
        }
        // button.addEventListener('click', test);
        // button.click();
      }
        
      function populateVoiceList() {
        if(typeof speechSynthesis === 'undefined') {
          console.log("speechSynthesis === undefined");
          return;
        }

        voices = speechSynthesis.getVoices();
        
        // for(var i = 0; i < voices.length; i++) {
        //   var option = document.createElement('option');
        //   option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

        //   if(voices[i].default) {
        //     option.textContent += ' -- DEFAULT';
        //   }

        //   option.setAttribute('data-lang', voices[i].lang);
        //   option.setAttribute('data-name', voices[i].name);
        //   document.getElementById("voiceSelect").appendChild(option);
        // }

        for(var i = 0; i < voices.length; i++) {
          var option = document.createElement('option');
          option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

          // console.log(voices[i].lang, typeof voices[i].lang);

          if (voices[i].lang == "da-DK" || voices[i].lang == "da_DK") {
            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            document.getElementById("voiceSelect").appendChild(option);
            // utterThis.voice = voices[i];
            index = i;
          }


          // if(voices[i].default) {
          //   option.textContent += ' -- DEFAULT';
          // }

          // option.setAttribute('data-lang', voices[i].lang);
          // option.setAttribute('data-name', voices[i].name);
          // document.getElementById("voiceSelect").appendChild(option);
          // console.log(option, typeof option);
        }
      }


      
      if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }
      

    </script>
  </body>
</html>
