<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Browser speech recognition</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.css"/> -->
  </head>
  <body>
    <!-- <header>
      <h1>Browser speech recognition</h1>
    </header> -->
    <main>
      <select id="voiceSelect" style="display: none;"></select>
      <h1 id="homeHeader"> Tryk p친 sk칝rmen for at snakke med Sara</h1>
      <div id="result">
      </div>
      <p id="responds"></p>

      <div id="frugtSnak"></div>
      
      <div id="frugtUI">  
        <!-- <p> 1 游꼝</p> -->
      </div>

      <select id="chosenTablet">
        <option value="tablet1">tablet 1</option>
        <option value="tablet2">tablet 2</option>
      </select>

      <p id="message" hidden aria-hidden="true">
        Your browser doesn't support Speech Recognition. Sorry.
      </p>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-database.js"></script>
    
    <script>

      //tjek b친de frugter og og numoffruits f칮r alle forloops
      
      const firebaseConfig = {
        apiKey: "AIzaSyDGYa_Vr_XnknIdru_LlaYVP116yzxe97A",
        authDomain: "frugtskaal.firebaseapp.com",
        databaseURL: "https://frugtskaal-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "frugtskaal",
        storageBucket: "frugtskaal.appspot.com",
        messagingSenderId: "156136853129",
        appId: "1:156136853129:web:19d39b4d516c5f351c0058",
        measurementId: "G-ZFHZHTPQN5"
      };
      
      firebase.initializeApp(firebaseConfig);

      // Get a reference to the database service
      var db = firebase.database();


      window.onload = test();
      //window.onload = window.scrollTo(0, 1);

      var synth = window.speechSynthesis;
      var voices;
      
      var utterThis = null;
      //var isFinishSpeaking;
      //utterThis.onend = function(){ isFinishSpeaking = true}

      var index;
      var trigger;
      var hasTwoDate = false;
      var noAnswer;
      var noAnswerTree2 = false;
      var chosenFruit;
      var chosenNum;
      var isHome = false;
      var finishedSpeaking = false;
      var hasOldAndNew;
      var tree2ManglerSvar = false;
      var moreThanOne;
      var invalidAnswerTree2;
      var minDateFruit;
      var minDateFruits =[]
      var minDate;
      var tree1Ongoing;
      var updateFrugtUI = true;

      


      //document.body.addEventListener("touchend", isHomeOrNot());
      document.body.addEventListener("click", () => isHomeOrNot());

      function isHomeOrNot() {
        isHome = isHome ? false : true; 
        console.log("is home? ", isHome);
        if (isHome) {
          document.getElementById("homeHeader").innerHTML = "Systemet er aktivt";
          document.getElementById("homeHeader").style.color = "green";
        } else  {
          document.getElementById("homeHeader").innerHTML = "Tryk p친 sk칝rmen for at snakke med Sara";
          document.getElementById("homeHeader").style.color = "grey";
        }
      }

      populateVoiceList();
      var tempDate;

      setInterval(() => {
        var theCurrentDate = new Date; // opdatere datoen hver time
        var theCurrentDateDay = theCurrentDate.getDate();

        if (tempDate != theCurrentDateDay) {
          tree2ManglerSvar = false; //dvs. tree 2 blive trigged
          //console.log("tree2ManglerSvar er set til false");
          tempDate = theCurrentDateDay;
        }

      }, 3600000);
      
      function test(){
        var hvadErDer = []
        const button = document.getElementById("button");
        const result = document.getElementById("result");
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        console.log("test() starts");

        //recognition.interimResults = true;
        recognition.interimResults = false;

        recognition.maxAlternatives = 1;
        recognition.lang = 'da-DK';

        recognition.start();

        var speechResult;
        const onResult = event => {
          result.innerHTML = "";
          for (const res of event.results) {
            const text = document.createTextNode(res[0].transcript);
            const p = document.createElement("p");
            if (res.isFinal) {
              p.classList.add("final");
              //console.log('Speech has stopped being detected');
              
              // button.click();
            }
            p.appendChild(text);
            result.appendChild(p);
            
            speechResult = event.results[0][0].transcript.toLowerCase();
            console.log(speechResult, typeof speechResult);

          }

          trigWordArrayInital = ['sara', 'zara']
          // ['frugtsk친l']
          if(isHome && (tree1Ongoing == false || tree1Ongoing == undefined) && checkTrigWord(speechResult, trigWordArrayInital, "hvad kan jeg g칮re for dig?")){
            tree1Ongoing = true;
          } 

          if (tree1Ongoing == undefined || tree1Ongoing == false) {
            document.getElementById("responds").style.color = "white";
            document.getElementById("responds").innerHTML = "Du mangler at aktivere mig ved at sige Sara";
            document.getElementById("frugtSnak").innerHTML = "";
          }
          

          console.log("trigger is: " + tree1Ongoing);
          trigWordArrayBuy = [' k칮b ', ' k칮bt ']
          trigWordArrayTake = [ ' tog', ' tage', ' spis']
          trigWordArrayNG = ['ny', 'gammel', "gamle"]
          trigWordArrayWhat = ["hvad har jeg", "hvad er der"]
          trigWordArrayJa = ["ja,", "ja." , "jo,", "jo.", " ja ", " jo ", "ja "]
          trigWordArrayNej = ["nej", "ellers tak"]


            db.ref().child(document.getElementById('chosenTablet').value + "/successSpeech").get().then((snapshot) => {
              setTimeout(() => {

                // console.log(Object.keys(snapshot.val()));
                // console.log(Object.values(snapshot.val()));
                // console.log(snapshot.val());
                //console.log(snapshot.val());

                var saraTal = 0;
                var spisTal = 0;
                var k칮bTal = 0;
                var nejTal = 0;
                var gammelTal = 0;
                var nyTal = 0;
                
                var test = snapshot.val();
                resultArr = {}
                console.log(Object.values(test).length);


                for (let k = 0; k < Object.values(test).length; k++) {
                  //Object.keys(test)[i].triggerWord
                  //console.log((Object.keys(test)[k]));
                  console.log(test[(Object.keys(test)[k])].triggerWord);
                  if (test[(Object.keys(test)[k])].triggerWord.includes("sara") || test[(Object.keys(test)[k])].triggerWord.includes("zara")) {
                    saraTal++;
                  }else if (test[(Object.keys(test)[k])].triggerWord.includes("spis") || test[(Object.keys(test)[k])].triggerWord.includes("tag")) {
                    spisTal++;
                  }else if (test[(Object.keys(test)[k])].triggerWord.includes("k칮b")) {
                    k칮bTal++;
                  }else if (test[(Object.keys(test)[k])].triggerWord.includes("nej") || test[(Object.keys(test)[k])].triggerWord.includes("ellers tak")  ) {
                    nejTal++;
                  }else if (test[(Object.keys(test)[k])].triggerWord.includes("gammel") || test[(Object.keys(test)[k])].triggerWord.includes("gamle")) {
                    gammelTal++;
                  }else if (test[(Object.keys(test)[k])].triggerWord.includes("ny")) {
                    nyTal++;
                  }

                   

                  if (k == Object.values(test).length-1 ) {
                    console.log("Sara: ", saraTal, " Spis/tage: ", spisTal, " K칮b: ", k칮bTal, " nej: ", nejTal, " gammel: ", gammelTal, " ny: ", nyTal);
                    console.log("total number of commands: ", Object.values(test).length, " counted commands: ", saraTal+spisTal+k칮bTal+nejTal+gammelTal+nyTal );
                  }

                  
                }

                // test.forEach(element => {
                // });
                // console.log((test));
                // console.log(test.triggerWord);
                
                console.log("jeg virker ");
                  // snapshot.forEach(function(trigwords) {
                  //   var dbResults = trigwords.val();
                  //   var test = dbResults.triggerWord
                  //   console.log(test);
                  // });
                }, 500);
              });

              // snapshot.forEach(function(frugtSnapshot) {
              //         var date = frugtSnapshot.val();
              //         currentAntal = parseInt(date.antal);
              //       });


          //tree 2 trigger = ishome, setinterval....
          
          if (isHome && tree2ManglerSvar == false && tree1Ongoing == false) {
            tree2ManglerSvar = true;
            //console.log("tree 2 starter");

            setTimeout(() => {

              //console.log("tree 2 settimeout");
              
              //step 1: get data fra DB, tjek hvilken frugt er mest t칝t p친 expired date
              var closestExpiryDate;
              var frugter;
              var datoArr = []

              db.ref().child(document.getElementById('chosenTablet').value + "/frugter").get().then((snapshot) => {
                //snapshot of each fruit
                var Arr = snapshot.val();

                Object.keys(Arr).forEach(element => {
                  //For each fruit
                  
                  db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + element).get().then((snapshot) => {
                    //snapshot get date
                    var dates = Object.keys(snapshot.val()) // string array af alle date i en bestem frugt
                    //closestExpiryDate = the nearest expirydate
                    if (dates.length == 2) {
                      if (dates[0] < dates[1]) {

                        closestExpiryDate = dates[0];
                      } else {
                        closestExpiryDate = dates[1];
                      }
                    } else if (dates.length == 1) {
                      closestExpiryDate = dates[0];
                    }
                    datoArr[element] = closestExpiryDate;
                    //console.log(datoArr);

                  });
                  
                });
              });
              
              // for at f친 array ud, brug settimeout (...,500), se linje 400 til 420
              setTimeout(() => {
                // var minDate;
                // var minDateFruit;

                //sorting DatoArr
                var sortableArr = [];
                for (var fruit in datoArr) {
                  sortableArr.push([fruit, datoArr[fruit]]);
                }
                sortableArr.sort(function(a, b) {
                  return new Date(a[1]) - new Date(b[1]);
                });
                
                var sortedDatoArr = {}
                sortableArr.forEach(function(item){
                  sortedDatoArr[item[0]]=item[1] 
                })

                for (var item in sortedDatoArr){
                  minDateFruit = item;
                  minDate = sortedDatoArr[item];
                  break;
                }
                
                //step 2: vis frugt emoji og f친 den til at snakke
                //tjek om der er en eller flere frugt d칮er samme dag
                if (sortedDatoArr[Object.keys(sortedDatoArr)[0]] == sortedDatoArr[Object.keys(sortedDatoArr)[1]]) {
                  moreThanOne = true;
                }else{
                  moreThanOne = false;
                }
                
                var fruitEmoji = {'칝bl': '游꼝','banan': '游꼛','p칝r': '游꼟', 'appelsin': "<img src='https://cdn.pixabay.com/photo/2016/02/23/17/42/orange-1218158_1280.png' height='140' width='140'>", 'vindru': '游꼖', 'mandarin': '游꼙', 'fersken': '游꼠', 'blomm': "<img src='https://brands-a.production.onewp.net/app/uploads/sites/95/2020/10/blomme-300x240.png' height='130' width='150'>"};
                
                //senario1: kun en frugt er ved at d칮 
                if (moreThanOne == false) {
                  var minDateFruitEmoji;

                  for (let i = 0; i < Object.keys(fruitEmoji).length; i++) {
                    if (Object.keys(fruitEmoji)[i] == minDateFruit) {
                      minDateFruitEmoji = fruitEmoji[Object.keys(fruitEmoji)[i]];
                    }
                  }

                  document.getElementById("frugtSnak").innerHTML = "<p>" + minDateFruitEmoji + '游눫 ' + "</p>";
                  
                  var currentDate = new Date;
                  var timeToDeath = new Date(minDate).getDate() - currentDate.getDate();
                  console.log("timeToDeath: ", timeToDeath);
                  
                  //2-2: utterance
                  var utterance;
                  if (timeToDeath == 0) {
                    utterance = "Jeg er fr칮ken " + minDateFruit + " og jeg er ved at blive for gammel, vil du ikke spise mig f칮r jeg d칮r idag";
                  } else if (timeToDeath > 0) {
                    utterance = "Jeg er fr칮ken " + minDateFruit + " og jeg er ved at blive for gammel, vil du ikke spise mig f칮r jeg d칮r om " + timeToDeath + " dage"; 
                  }else if (timeToDeath < 0) {
                    var dage = timeToDeath * -1;
                    utterance = "Jeg er fr칮ken " + minDateFruit + " og jeg er t칝t p친 at d칮, jeg d칮de m친ske for " + dage + " dage siden, spis mig hvis jeg stadig er god";
                  }
                  utterThis = new SpeechSynthesisUtterance(utterance);
                  utterThis.voice = voices[index];
                  //utterThis.rate = 0.8;
                  synth.speak(utterThis);
                  document.getElementById("responds").innerHTML = utterance;
                  //utterThis.rate = 1;
                  utterThis.onend = function(){
                    finishedSpeaking = true;
                    //utterThis.rate = 1;
                    //console.log("UtterThis tree 2");
                  }
                  // tree2ManglerSvar = true;
                  noAnswerTree2 = true;
                }
                //senario2: mere end en frugt er ved at d칮de
                else if (moreThanOne == true) {
                  var minDateFruitEmojis =[]
                  //var minDateFruits =[]
                  //var minDate = sortedDatoArr[Object.keys(sortedDatoArr)[0]];
                  
                  //get frugter der d칮 de samme date
                  var num = 0;
                  for (var item in sortedDatoArr){
                    if (sortedDatoArr[item] == minDate) {
                      minDateFruits[num] = item;
                      num++;
                    } else {
                      break;
                    }
                  }

                  for (let i = 0, j = 0; i < Object.keys(fruitEmoji).length; i++) {
                    //loop igennem alle emoji
                    minDateFruits.forEach(element => {
                      if (Object.keys(fruitEmoji)[i] == element) {
                        minDateFruitEmojis[j] = fruitEmoji[Object.keys(fruitEmoji)[i]];
                        j++;
                      }
                    });
                  }
                  console.log(minDateFruits, minDate);
                  //vis emojis
                  var ShowFruitEmojis = "";
                  minDateFruitEmojis.forEach(element => {
                    ShowFruitEmojis += element;
                  });
                  noAnswerTree2 = true;

                  document.getElementById("frugtSnak").innerHTML = "<p>" + ShowFruitEmojis + '游눫 ' + "</p>";
                  
                  var currentDate = new Date;
                  var timeToDeath = new Date(minDate).getDate() - currentDate.getDate();
                  console.log("timeToDeath: ", timeToDeath);

                  //frugter snakker
                  var utterance;
                  if (timeToDeath == 0) {
                    utterance = "Vi er ved at blive for gamle, vil du ikke spise os f칮r vi d칮r idag";
                  } else if (timeToDeath > 0) {
                    utterance = "Vi er ved at blive for gamle, vil du ikke spise os f칮r vi d칮r om " + timeToDeath + " dage"; 
                  }else if (timeToDeath < 0) {
                    var dage = timeToDeath * -1;
                    utterance = "Vi er t칝t p친 at d칮, vi d칮de m친ske for " + dage + " dage siden, spis en af os hvis en af os stadig er ";
                  }

                  utterThis = new SpeechSynthesisUtterance(utterance);
                  utterThis.voice = voices[index];
                  //utterThis.rate = 0.7;
                  synth.speak(utterThis);
                  document.getElementById("responds").innerHTML = utterance;
                  utterThis.onend = function(){
                    finishedSpeaking = true;
                    //utterThis.rate = 1;
                    //console.log("UtterThis tree 2");
                  }


                  //hvis svar ja: sporge hvilken frugt 
                 
                }
                tree1Ongoing = true;

                
                //hvis svar nej: sporge igen senere, skifte max og min ind i setinterval

              }, 1000)
              
              
               
            }, Math.random() * (7200000 - 3600000) + 3600000);

            //tree 2 slutter her
          }

          //Tree 1 trigger = ishome + "hey frugtskaal"
          // mangler trigger "ikke i tree 2" => Tree 1 og 2 m친 ikke k칮re p친 samme tid
          if (isHome && tree1Ongoing) { 
            //tree1Ongoing = true;
            //console.log("inde i tree 1 isHome: ", isHome, " tree1Ongoing: ", tree1Ongoing, "tree2manglersvar: ", tree2ManglerSvar);
            document.getElementById("responds").style.color = "white";
            //document.getElementById("responds").innerHTML = "";
            var numOfFruits = speechResult.match(/ en | et | 칠n | to | tre | fire | fem | seks | syv | otte | ni | ti |\d+/g);
            var fruits = speechResult.match(/칝bl|banan|p칝r|appelsin|vindru|vindu|mandarin|fersken|blomm/g);
            
            if (numOfFruits != undefined) {
              numOfFruits.forEach(function(element, index) {
                if (element == " et " || element == " en " || element == " 칠n ") {
                  numOfFruits.splice(index, 1, "1");
                }else if (element == " to ") {
                  numOfFruits.splice(index, 1, "2");
                }else if (element == " tre ") {
                  numOfFruits.splice(index, 1, "3");
                }else if (element == " fire ") {
                  numOfFruits.splice(index, 1, "4");
                }else if (element == " fem ") {
                  numOfFruits.splice(index, 1, "5");
                }else if (element == " seks ") {
                  numOfFruits.splice(index, 1, "6");
                }else if (element == " syv ") {
                  numOfFruits.splice(index, 1, "7");
                }else if (element == " otte ") {
                  numOfFruits.splice(index, 1, "8");
                }else if (element == " ni ") {
                  numOfFruits.splice(index, 1, "9");
                }else if (element == " ti ") {
                  numOfFruits.splice(index, 1, "10");
                }
              })
            }
            
            if (fruits != null) {
              fruits.forEach(function(element, index) {
                if (element == "vindu") {
                  fruits.splice(index, 1, "vindru");
                }
              })
            }

            
            console.log("number: ", numOfFruits, typeof numOfFruits);
            console.log("fruits: ", fruits);
            // console.log("du har k칮bt: " + numOfFruits[0] + " " + fruits[0]);
            console.log("ligef칮r buy ", fruits != undefined, numOfFruits != undefined, "noAnswerTree2 burde v칝re true: ", noAnswerTree2 == false);
            console.log("speechResult: ", speechResult, "does it include buy: ", speechResult.includes("k칮b"));
            
            if (fruits != undefined && numOfFruits != undefined && noAnswerTree2 == false && checkTrigWord(speechResult, trigWordArrayBuy, "Okay, det er noteret")){
              console.log("buy was success");
              var expiryDateArr = {'칝bl': 5,'banan': 3,'p칝r': 3, 'appelsin': 5, 'vindru': 3, 'mandarin': 5, 'fersken': 2, 'blomm': 3};
              //set in i DB
              for (let i = 0; i < fruits.length; i++) {
                var date = new Date();
                //console.log(fruits[i], typeof fruits[i], expiryDateArr[fruits[i]]);
                var expiryDate = expiryDateArr[fruits[i]];
                date.setDate(date.getDate() + expiryDate);

                var dateStr = date.toISOString().slice(0, 10);

                //console.log(expiryDate, date);
                writeData(numOfFruits[i], fruits[i], dateStr);
                console.log(date, typeof date);
                console.log(dateStr, typeof date)
              }

              // const db = firebase.database();
              function writeData(num, fruit, date) {
                db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruit + "/" + date).set({
                  antal: num,
                });
              }

              tree1Ongoing = false;
              updateFrugtUI = true;

            } else if (fruits != undefined && noAnswerTree2 == false && checkTrigWord(speechResult, trigWordArrayBuy, "Jeg h칮rte ikke hvor mange frugter, pr칮v igen")) {
              
            } else if (numOfFruits != undefined && noAnswerTree2 == false && checkTrigWord(speechResult, trigWordArrayBuy, "Jeg h칮rte ikke hvilken frugter du k칮bte, pr칮v igen")) {

            } else if (noAnswerTree2 == false && checkTrigWord(speechResult, trigWordArrayBuy, "Undskyld jeg h칮rte dig ikke ordentligt, pr칮v igen")) {
              
            }

            

            if (fruits != undefined && numOfFruits != undefined && noAnswerTree2 == false && hasTwoDate == false && checkTrigWordTake(speechResult, trigWordArrayTake)) {

              for (let i = 0; i < fruits.length; i++) {
                hasTwoDate = false;
                utterThis = 1;
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + fruits[i]).get().then((snapshot) => {
                  if (Object.keys(snapshot.val()).length > 1){
                    var utterance = "Har du taget  af de gamle " + fruits[i] + "er eller  af de nye " + fruits[i] + "er";
                    utterThis = new SpeechSynthesisUtterance(utterance);
                    utterThis.voice = voices[index];
                    synth.speak(utterThis);
                    document.getElementById("responds").innerHTML = utterance;
                    utterThis.onend = function(){
                      finishedSpeaking = true;
                      console.log("ind i taget function, both new and old", finishedSpeaking);
                      console.log("trigwordarray utterthis: ", utterThis);
                    }

                    hasTwoDate = true;
                    chosenFruit = fruits;
                    chosenNum = numOfFruits;
                    //tree1Ongoing = false;
                  }else{
                    var utterance = "Okay, tak";
                    utterThis = new SpeechSynthesisUtterance("Okay, det er noteret");
                    utterThis.voice = voices[index];
                    synth.speak(utterThis);
                    document.getElementById("responds").innerHTML = "Okay, det er noteret";
                    utterThis.onend = function(){
                      finishedSpeaking = true;
                      console.log("ind i taget function, both new and old", finishedSpeaking);
                      
                    }
                    

                    var currentAntal;
                    snapshot.forEach(function(frugtSnapshot) {
                      var date = frugtSnapshot.val();
                      currentAntal = parseInt(date.antal);
                    });
                    
                    db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).update({
                      antal: currentAntal - parseInt(numOfFruits[i])
                    });

                    if (currentAntal <= parseInt(numOfFruits[i])) {
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).remove();
                    }
                    tree1Ongoing = false;
                    updateFrugtUI = true;
                  }
                });
              }
            } else if (noAnswerTree2 == false && fruits != undefined && hasTwoDate == false && checkTrigWord(speechResult, trigWordArrayTake, "Jeg h칮rte ikke hvor mange frugter du tog, pr칮v igen")) {
              
            } else if (noAnswerTree2 == false && numOfFruits != undefined && hasTwoDate == false && checkTrigWord(speechResult, trigWordArrayTake, "Jeg h칮rte ikke hvilke frugter du tog, pr칮v igen")) {
              
            } else if(noAnswerTree2 == false && hasTwoDate == false && checkTrigWord(speechResult, trigWordArrayTake, "Undskyld jeg h칮rte dig ikke ordentligt, pr칮v igen")) {

            }


            if (noAnswerTree2 == false && hasTwoDate && checkTrigWord(speechResult, trigWordArrayNG, "okay, tak")) {
              //console.log("ny eller gammel?");
              var nyDate;
              var gamleDate;
              var currentAntal;
              for (let i = 0; i < chosenFruit.length; i++) {
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i]).get().then((snapshot) => {
                  dates = Object.keys(snapshot.val()); //string array
                  
                  if (dates[0] < dates[1]) {
                    gamleDate = dates[0];
                    nyDate = dates[1];
                    console.log("f칮rst er mindre end andet");
                    console.log(gamleDate, nyDate);
                  } else {
                    gamleDate = dates[1];
                    nyDate = dates[0];
                    console.log("anden er mindre end f칮rste");
                    console.log(gamleDate, nyDate);
                  }

                  if (speechResult.includes("ny")) {
                    db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i] + "/" + nyDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + nyDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + nyDate).remove();
                      }
                    });
                    
                  } else if (speechResult.includes("gamle") || speechResult.includes("gammel")) {
                    db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i] + "/" + gamleDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + gamleDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + gamleDate).remove();
                      }
                    });
                  }

                });
                
              }

              hasTwoDate = false;  
              noAnswer = false;
              tree1Ongoing = false;
              updateFrugtUI = true;
            } 

            if (noAnswerTree2 == false && hasTwoDate && noAnswer) {
              var utterance = "Du mangler at svare om det er den nye eller den gamle som er blevet taget";
              utterThis = new SpeechSynthesisUtterance(utterance);
              utterThis.voice = voices[index];
              synth.speak(utterThis);
              document.getElementById("responds").innerHTML = utterance;
              utterThis.onend = function(){
                finishedSpeaking = true;
              }

            }
            
            if (tree2ManglerSvar == true && noAnswerTree2 == true) {
              //invalidAnswerTree2 == true;
              //invalidAnswerTree2 
              //code k칮r f칮rst efter tree2 er blivet trigged og sys(tree2) er f칝rdig med at snakke
              
              //4 tilf칝lder
               //1. 1 frugt + ja - set invalidAnswerTree2 = false
               if (moreThanOne == false && checkTrigWord(speechResult, trigWordArrayJa, "Tak for at redde mig fra d칮den, du er min helt")) {
                //database fjern 1 frugt
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + minDateFruit + "/" + minDate).get().then((snapshot) => {
                  currentAntal = parseInt(snapshot.val().antal);
                  
                  db.ref(document.getElementById('chosenTablet').value + '/frugter/' + minDateFruit + "/" + minDate).update({
                    antal: currentAntal - 1
                  });
                  console.log(currentAntal);

                  if (currentAntal <= 1) {
                    db.ref(document.getElementById('chosenTablet').value + '/frugter/' + minDateFruit + "/" + minDate).remove();
                    console.log("burde fjerne en frugt");
                  }
                  
                });
                //fjerne emoji
                setTimeout(() => {
                  document.getElementById("frugtSnak").innerHTML = "";
                  document.getElementById("responds").innerHTML = "";
                }, 3000);

                invalidAnswerTree2 = false;
                noAnswerTree2 = false;
                tree1Ongoing = false;
                updateFrugtUI = true;
               }
               //2. >1 frugt + ja(hvilken frugt) - set invalidAnswerTree2 = false
               else if (moreThanOne == true && fruits != null && checkTrigWord(speechResult, trigWordArrayJa, "Tak for at redde mig fra d칮den, du er min helt")){
                 
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + fruits[0] + "/" + minDate).get().then((snapshot) => {
                  currentAntal = parseInt(snapshot.val().antal);
                  
                  db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[0] + "/" + minDate).update({
                    antal: currentAntal - 1
                  });
                  console.log(currentAntal);

                  if (currentAntal <= 1) {
                    db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[0] + "/" + minDate).remove();
                    console.log("burde fjerne en frugt");
                  }
                });
                //fjerne emoji
                setTimeout(() => {
                  document.getElementById("frugtSnak").innerHTML = "";
                  document.getElementById("responds").innerHTML = "";
                }, 3000);
                
                invalidAnswerTree2 = false;
                noAnswerTree2 = false;
                tree1Ongoing = false;
                updateFrugtUI = true;
                
               } else if (moreThanOne == true && fruits == null && checkTrigWord(speechResult, trigWordArrayJa, "Jeg h칮rte ikke hvilken frugt du tog, pr칮v igen")) {
                 
               } 
               //3. nej - set invalidAnswerTree2 = false
               else if (moreThanOne == false && checkTrigWord(speechResult, trigWordArrayNej, "Jamen s친 ligger jeg bare her og d칮r")) {
                //fjerne emoji 
                setTimeout(() => {
                  document.getElementById("frugtSnak").innerHTML = "";
                  document.getElementById("responds").innerHTML = "";
                }, 3000);                
                
                //reset tree2 med ny tid i settimeout
                tree2ManglerSvar = false;

                invalidAnswerTree2 = false;
                noAnswerTree2 = false;
                tree1Ongoing = false;
               }else if (moreThanOne == true && checkTrigWord(speechResult, trigWordArrayNej, "Jamen s친 ligger vi bare her og d칮r")) {
                 //fjerne emoji 
                setTimeout(() => {
                  document.getElementById("frugtSnak").innerHTML = "";
                  document.getElementById("responds").innerHTML = "";
                }, 3000);                
                
                //reset tree2 med ny tid i settimeout
                tree2ManglerSvar = false;

                invalidAnswerTree2 = false;
                noAnswerTree2 = false;
                tree1Ongoing = false;
                 
               }
               //4. invalid svar invalidAnswerTree2 = T
                //4.1 morethanone T
               else if (invalidAnswerTree2 == true) {
                var utterance;
                if (moreThanOne == false) {
                  utterance = "Du glemte at svare om vil redde mig eller lade mig d칮";
                }else if (moreThanOne == true) {
                  utterance = "Du glemte at svare om vil redde en af os eller lade os alle d칮";
                }
                utterThis = new SpeechSynthesisUtterance(utterance);
                utterThis.voice = voices[index];
                synth.speak(utterThis);
                document.getElementById("responds").innerHTML = utterance;
                utterThis.onend = function(){
                  finishedSpeaking = true;
                }
               }
                   //4.1.1 
                //4.2 morethanone F
                

              // samlet nej
            }

            noAnswer = true;
            invalidAnswerTree2 = true;
            //console.log("HasTwoDate should be true: " + hasTwoDate);

            //slutning af tree 1
          }

          if (updateFrugtUI == true) {
            var fruitWithNum = []
              db.ref().child(document.getElementById('chosenTablet').value + "/frugter").get().then((snapshot) => {
                //snapshot of each fruit
                // var totalAntal;

                // console.log(snapshot.val());
                var output;
                var Arr = snapshot.val();
                //console.log(Object.keys(Arr).length);

                Object.keys(Arr).forEach(element => {
                  //For each fruit
                  var totalAntal = 0;
                  db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + element).get().then((snapshot) => {
                    //snapshot get date
                    
                    // console.log("date: ", Object.keys(snapshot.val()));
                    for (let i = 0; i < Object.keys(snapshot.val()).length; i++) {
                      var dateArr = Object.keys(snapshot.val());
                      var antal; 

                      db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + element + "/" + dateArr[i]).get().then((snapshot) => {
                      //snapshot get antal
                                               
                        antal = parseInt(Object.values(snapshot.val())[0]);
                        totalAntal += antal;
                        fruitWithNum[element] = totalAntal;
                        hvadErDer = fruitWithNum;
                      });
                    }
                  });
                });
              });
              setTimeout(() => {
                //console.log(hvadErDer, Object.keys(hvadErDer).length);
                //function som viser UI 
                var emojis = []
                var totalNum = []
                var fruitEmoji = {'칝bl': '游꼝','banan': '游꼛','p칝r': '游꼟', 'appelsin': "<img src='https://cdn.pixabay.com/photo/2016/02/23/17/42/orange-1218158_1280.png' height='45' width='45'>", 'vindru': '游꼖', 'mandarin': '游꼙', 'fersken': '游꼠', 'blomm': "<img src='https://brands-a.production.onewp.net/app/uploads/sites/95/2020/10/blomme-300x240.png' height='45' width='45'>"};
                for (let i = 0; i < Object.keys(hvadErDer).length; i++) {
                  emojis[i] = fruitEmoji[Object.keys(hvadErDer)[i]];
                  totalNum[i] = Object.values(hvadErDer)[i];

                }
                
                //console.log(emojis, totalNum);
                document.getElementById("frugtUI").innerHTML = "";
                var space = " ";
                document.getElementById("frugtUI").innerHTML += "<br>";
                
                for (let i = 0; i < emojis.length; i++) { 

                  if (i == 3) {
                    document.getElementById("frugtUI").innerHTML += "<span>" + totalNum[i] + " " + emojis[i] + "</span>";
                    document.getElementById("frugtUI").innerHTML += "<br><br><br>";
                  }else{
                    document.getElementById("frugtUI").innerHTML += "<span>" + totalNum[i] + " " + emojis[i] + "</span>";
                  }                 
                  
                }

              }, 500);

              updateFrugtUI = false;
          }
          
          function checkTrigWord(speech, trigWordArray, utterance) {
            var istriggered = false;
            trigWordArray.forEach(function(element) {
              if (speech.includes(element)) {
                recognition.stop();
                populateVoiceList();
                utterThis = new SpeechSynthesisUtterance(utterance);
                utterThis.voice = voices[index];
                synth.speak(utterThis);

                document.getElementById("responds").innerHTML = utterance;
                //delay 

                utterThis.onend = function(){
                  //console.log("utterthis.onend", Object.values(utterThis.text));
                  finishedSpeaking = true;              
                  //test();
                }

                istriggered = true;

                //log successful speech in DB
                // var currentDate = new Date();
                // var dateAndTime = currentDate.getFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate()+' '+currentDate.getHours() + ":" + currentDate.getMinutes() + ":" + currentDate.getSeconds();
                // db.ref(document.getElementById('chosenTablet').value + '/successSpeech/' + dateAndTime).set({
                //   input: speech,
                //   triggerWord: element
                // });
                // speechIndex ++;
              }
              
            })
            return istriggered;
          }
          

          function checkTrigWordTake(speech, trigWordArray) {
            var istriggered = false;
            trigWordArray.forEach(function(element) {
              if (speech.includes(element)) {
                recognition.stop();
                istriggered = true;

                //log successful speech in DB
                var currentDate = new Date();
                var dateAndTime = currentDate.getFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate()+' '+currentDate.getHours() + ":" + currentDate.getMinutes() + ":" + currentDate.getSeconds();
                db.ref(document.getElementById('chosenTablet').value + '/successSpeech/' + dateAndTime).set({
                  input: speech,
                  triggerWord: element
                });
                // speechIndex ++;
              }
              
            })
            return istriggered;
          }

          // if trigger slutter her
          console.log("Speech result:" + speechResult);
        }
        

        
        
        recognition.addEventListener("result", onResult);

        
        recognition.onspeechend = function(){
          recognition.stop();
          console.log("on speech end");
        }
        
        recognition.onsoundstart = function(){
          console.log("on sound start");
        }

        
        function checkFlag() {
          if(finishedSpeaking == false) {
            window.setTimeout(checkFlag, 100); /* this checks the flag every 100 milliseconds*/
          } else {
            finishedSpeaking = false;
            test()
          }
        }

        
        recognition.onend = function (){
          //console.log(utterThis);
          console.log("inside onend now");
          console.log("utterThis: ", utterThis," IsHome: ", isHome);
          console.log("finishedSpeaking: ", finishedSpeaking);
          
          checkFlag();

          if(utterThis == undefined && (isHome == false || isHome == true) ){
            console.log("utterThis is undefined");
            test();
          }
          utterThis = undefined;

          if (isHome == false || isHome == undefined) {
            document.getElementById("responds").innerHTML = "Systemet er ikke aktiveret";
            document.getElementById("responds").style.color = "red";
          } 
          
        }
        
        //test() slutter
        updateFrugtUI = true;
      }


      function populateVoiceList() {
        if(typeof speechSynthesis === 'undefined') {
          console.log("speechSynthesis === undefined");
          return;
        }

        voices = speechSynthesis.getVoices();

        for(var i = 0; i < voices.length; i++) {
          var option = document.createElement('option');
          option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

          // console.log(voices[i].lang, typeof voices[i].lang);

          if (voices[i].lang == "da-DK" || voices[i].lang == "da_DK") {
            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            document.getElementById("voiceSelect").appendChild(option);
            // utterThis.voice = voices[i];
            index = i;
          }
        }
      }

      
      if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }
      

    </script>

    
  </body>
</html>
