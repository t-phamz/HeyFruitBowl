<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Browser speech recognition</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.css"/> -->
  </head>
  <body>
    <!-- <header>
      <h1>Browser speech recognition</h1>
    </header> -->
    <main>
      <select id="voiceSelect" style="display: none;"></select>
      <h1 id="homeHeader"> Tryk p√• sk√¶rmen for at snakke med frugtsk√•len</h1>
      <div id="result">
      </div>
      <p id="responds"></p>
      <div id="frugtUI">  
        <!-- <p> 1 üçé</p> -->
      </div>

      <select id="chosenTablet">
        <option value="tablet1">tablet 1</option>
        <option value="tablet2">tablet 2</option>
      </select>

      <!-- <div id="button">
        <label class="switch">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </div> -->
      <p id="message" hidden aria-hidden="true">
        Your browser doesn't support Speech Recognition. Sorry.
      </p>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-database.js"></script>
    
    <script>

      //tjek b√•de frugter og og numoffruits f√∏r alle forloops
      
      const firebaseConfig = {
        apiKey: "AIzaSyDGYa_Vr_XnknIdru_LlaYVP116yzxe97A",
        authDomain: "frugtskaal.firebaseapp.com",
        databaseURL: "https://frugtskaal-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "frugtskaal",
        storageBucket: "frugtskaal.appspot.com",
        messagingSenderId: "156136853129",
        appId: "1:156136853129:web:19d39b4d516c5f351c0058",
        measurementId: "G-ZFHZHTPQN5"
      };
      
      firebase.initializeApp(firebaseConfig);

      // Get a reference to the database service
      var db = firebase.database();


      window.onload = test();
      //window.onload = window.scrollTo(0, 1);

      var synth = window.speechSynthesis;
      var voices;
      
      var utterThis;
      //var isFinishSpeaking;
      //utterThis.onend = function(){ isFinishSpeaking = true}

      var index;
      var trigger;
      var hasTwoDate = false;
      var noAnswer;
      var chosenFruit;
      var chosenNum;
      var isHome = false;


      //document.body.addEventListener("touchend", isHomeOrNot());
      document.body.addEventListener("click", () => isHomeOrNot());
      //ocument.body.addEventListener("click", () => alertTest());
      
      function isHomeOrNot() {
        isHome = isHome ? false : true; 
        console.log("is home? ", isHome);
        if (isHome) {
          document.getElementById("homeHeader").innerHTML = "Systemet er aktivt";
          document.getElementById("homeHeader").style.color = "green";
        } else  {
          document.getElementById("homeHeader").innerHTML = "Tryk p√• sk√¶rmen for at snakke med frugtsk√•len";
          document.getElementById("homeHeader").style.color = "grey";
        }
      }

      populateVoiceList();
      
      function test(){
        var hvadErDer = []
        const button = document.getElementById("button");
        const result = document.getElementById("result");
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        console.log("test() starts");

        //recognition.interimResults = true;
        recognition.interimResults = false;

        recognition.maxAlternatives = 1;
        recognition.lang = 'da-DK';

        recognition.start();

        var speechResult;
        const onResult = event => {
          result.innerHTML = "";
          for (const res of event.results) {
            const text = document.createTextNode(res[0].transcript);
            const p = document.createElement("p");
            if (res.isFinal) {
              p.classList.add("final");
              //console.log('Speech has stopped being detected');
              
              // button.click();
            }
            p.appendChild(text);
            result.appendChild(p);
            
            speechResult = event.results[0][0].transcript.toLowerCase();
            console.log(speechResult, typeof speechResult);
            // if (speechResult.includes("frugtsk√•l")) {
            //   console.log("SUCCESS");
            //   //Tree 1 (user started) 
            //   utterThis = new SpeechSynthesisUtterance("hvad kan jeg g√∏re for dig?");
            //   synth.speak(utterThis);
            // }
          }

          trigWordArrayInital = ['tak', 'Tak']
          if(checkTrigWord(speechResult, trigWordArrayInital, "hvad kan jeg g√∏re for dig?")){
            trigger = true;
          }
          console.log("trigger is: " + trigger);
          trigWordArrayBuy = [' k√∏b']
          trigWordArrayTake = [ ' tog', ' tage', ' spis']
          trigWordArrayNG = ['ny', 'gammel', "gamle"]
          trigWordArrayWhat = ["hvad har jeg", "hvad er der"]

         
          //√ÜNDRE TRUE TIL TRIGGER

          if (isHome) { 
            console.log(isHome);
            document.getElementById("responds").style.color = "white";
            var numOfFruits = speechResult.match(/ en | et | √©n | to | tre | fire | fem | seks | syv | otte | ni | ti |\d+/g);
            var fruits = speechResult.match(/√¶bl|banan|p√¶r|appelsin|vindru|vindu|mandarin|fersken|blomm/g);
          
            if (numOfFruits != undefined) {
              numOfFruits.forEach(function(element, index) {
                if (element == " et " || element == " en " || element == " √©n ") {
                  numOfFruits.splice(index, 1, "1");
                }else if (element == " to ") {
                  numOfFruits.splice(index, 1, "2");
                }else if (element == " tre ") {
                  numOfFruits.splice(index, 1, "3");
                }else if (element == " fire ") {
                  numOfFruits.splice(index, 1, "4");
                }else if (element == " fem ") {
                  numOfFruits.splice(index, 1, "5");
                }else if (element == " seks ") {
                  numOfFruits.splice(index, 1, "6");
                }else if (element == " syv ") {
                  numOfFruits.splice(index, 1, "7");
                }else if (element == " otte ") {
                  numOfFruits.splice(index, 1, "8");
                }else if (element == " ni ") {
                  numOfFruits.splice(index, 1, "9");
                }else if (element == " ti ") {
                  numOfFruits.splice(index, 1, "10");
                }
              })
            }

            if (fruits != null) {
              fruits.forEach(function(element, index) {
                if (element == "vindu") {
                  fruits.splice(index, 1, "vindru");
                }
              })
            }
            
            console.log("number: ", numOfFruits, typeof numOfFruits);
            console.log("fruits: ", fruits);
            // console.log("du har k√∏bt: " + numOfFruits[0] + " " + fruits[0]);
            
            if (fruits != undefined && numOfFruits != undefined && checkTrigWord(speechResult, trigWordArrayBuy, "Er det alt du har k√∏bt?")){

              var expiryDateArr = {'√¶bl': 5,'banan': 3,'p√¶r': 3, 'appelsin': 5, 'vindru': 3, 'mandarin': 5, 'fersken': 2, 'blomm': 3};
              //set in i DB
              for (let i = 0; i < fruits.length; i++) {
                var date = new Date();
                //console.log(fruits[i], typeof fruits[i], expiryDateArr[fruits[i]]);
                var expiryDate = expiryDateArr[fruits[i]];
                date.setDate(date.getDate() + expiryDate);

                var dateStr = date.toISOString().slice(0, 10);

                //console.log(expiryDate, date);
                writeData(numOfFruits[i], fruits[i], dateStr);
                console.log(date, typeof date);
                console.log(dateStr, typeof date)
              }

              // const db = firebase.database();
              function writeData(num, fruit, date) {
                db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruit + "/" + date).set({
                  antal: num,
                });
              }

            } else if (fruits != undefined && checkTrigWord(speechResult, trigWordArrayBuy, "Jeg h√∏rte ikke hvor mange frugter, pr√∏v igen")) {
              
            } else if (numOfFruits != undefined && checkTrigWord(speechResult, trigWordArrayBuy, "Jeg h√∏rte ikke hvilken frugter du k√∏bte, pr√∏v igen")) {

            } else if (checkTrigWord(speechResult, trigWordArrayBuy, "Undskyld jeg h√∏rte dig ikke ordentligt, pr√∏v igen")) {
              
            }
            
            // console.log("HasTwoDate: " + hasTwoDate);

            if (fruits != undefined && numOfFruits != undefined && checkTrigWord(speechResult, trigWordArrayTake, " ") && hasTwoDate == false) {
              
              // utterThis = new SpeechSynthesisUtterance("Okay, det er noteret");
              // utterThis.voice = voices[index];
              // synth.speak(utterThis);
              // document.getElementById("responds").innerHTML = "Okay, det er noteret";

              for (let i = 0; i < fruits.length; i++) {
                hasTwoDate = false;
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + fruits[i]).get().then((snapshot) => {
                  if (Object.keys(snapshot.val()).length > 1){
                    var utterance = "Har du taget en af de gamle " + fruits[i] + "er eller en af de nye " + fruits[i] + "er";
                    utterThis = new SpeechSynthesisUtterance(utterance);
                    utterThis.voice = voices[index];
                    synth.speak(utterThis);
                    document.getElementById("responds").innerHTML = utterance;
                    hasTwoDate = true;
                    chosenFruit = fruits;
                    chosenNum = numOfFruits;
                  }else{
                    utterThis = new SpeechSynthesisUtterance("Okay, det er noteret");
                    utterThis.voice = voices[index];
                    synth.speak(utterThis);
                    document.getElementById("responds").innerHTML = "Okay, det er noteret";
                    var currentAntal;
                    snapshot.forEach(function(frugtSnapshot) {
                      var date = frugtSnapshot.val();
                      currentAntal = parseInt(date.antal);
                    });
                    
                    db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).update({
                      antal: currentAntal - parseInt(numOfFruits[i])
                    });

                    if (currentAntal <= parseInt(numOfFruits[i])) {
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).remove();
                    }
                  }
                });
              }
            } else if (fruits != undefined && checkTrigWord(speechResult, trigWordArrayTake, "Jeg h√∏rte ikke hvor mange frugter du tog, pr√∏v igen") && hasTwoDate == false) {
              
            } else if (numOfFruits != undefined && checkTrigWord(speechResult, trigWordArrayTake, "Jeg h√∏rte ikke hvilke frugter du tog, pr√∏v igen") && hasTwoDate == false) {
              
            } else if(checkTrigWord(speechResult, trigWordArrayTake, "Undskyld jeg h√∏rte dig ikke ordentligt, pr√∏v igen")) {

            }


            if (hasTwoDate && checkTrigWord(speechResult, trigWordArrayNG, "okay, tak")) {
              //console.log("ny eller gammel?");
              var nyDate;
              var gamleDate;
              var currentAntal;
              for (let i = 0; i < chosenFruit.length; i++) {
                db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i]).get().then((snapshot) => {
                  dates = Object.keys(snapshot.val()); //string array
                  
                  if (dates[0] < dates[1]) {
                    gamleDate = dates[0];
                    nyDate = dates[1];
                    console.log("f√∏rst er mindre end andet");
                    console.log(gamleDate, nyDate);
                  } else {
                    gamleDate = dates[1];
                    nyDate = dates[0];
                    console.log("anden er mindre end f√∏rste");
                    console.log(gamleDate, nyDate);
                  }

                  if (speechResult.includes("ny")) {
                    db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i] + "/" + nyDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + nyDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + nyDate).remove();
                      }
                    });
                    
                  } else if (speechResult.includes("gamle") || speechResult.includes("gammel")) {
                    db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + chosenFruit[i] + "/" + gamleDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + gamleDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref(document.getElementById('chosenTablet').value + '/frugter/' + chosenFruit[i] + "/" + gamleDate).remove();
                      }
                    });
                  }
                });
                
              }

              hasTwoDate = false;  
              noAnswer = false;
            } 

            if (hasTwoDate && noAnswer) {
              var utterance = "Du mangler at svare om det er den nye eller den gamle som er blevet taget";
              utterThis = new SpeechSynthesisUtterance(utterance);
              utterThis.voice = voices[index];
              synth.speak(utterThis);
              document.getElementById("responds").innerHTML = utterance;
            }


            noAnswer = true;
            console.log("HasTwoDate should be true: " + hasTwoDate);

          }else{
            //test();
          }

          setInterval(() => {
            var fruitWithNum = []
              db.ref().child(document.getElementById('chosenTablet').value + "/frugter").get().then((snapshot) => {
                //snapshot of each fruit
                // var totalAntal;

                // console.log(snapshot.val());
                var output;
                var Arr = snapshot.val();
                //console.log(Object.keys(Arr).length);

                Object.keys(Arr).forEach(element => {
                  //For each fruit
                  var totalAntal = 0;
                  db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + element).get().then((snapshot) => {
                    //snapshot get date
                    
                    // console.log("date: ", Object.keys(snapshot.val()));
                    for (let i = 0; i < Object.keys(snapshot.val()).length; i++) {
                      var dateArr = Object.keys(snapshot.val());
                      var antal; 

                      db.ref().child(document.getElementById('chosenTablet').value + "/frugter/" + element + "/" + dateArr[i]).get().then((snapshot) => {
                      //snapshot get antal
                                               
                        antal = parseInt(Object.values(snapshot.val())[0]);
                        totalAntal += antal;
                        fruitWithNum[element] = totalAntal;
                        hvadErDer = fruitWithNum;
                      });
                    }
                  });
                });
              });
              setTimeout(() => {
                //console.log(hvadErDer, Object.keys(hvadErDer).length);
                //function som viser UI 
                var emojis = []
                var totalNum = []
                var fruitEmoji = {'√¶bl': 'üçé','banan': 'üçå','p√¶r': 'üçê', 'appelsin': "<img src='https://cdn.pixabay.com/photo/2016/02/23/17/42/orange-1218158_1280.png' height='45' width='45'>", 'vindru': 'üçá', 'mandarin': 'üçä', 'fersken': 'üçë', 'blomm': "<img src='https://brands-a.production.onewp.net/app/uploads/sites/95/2020/10/blomme-300x240.png' height='45' width='45'>"};
                for (let i = 0; i < Object.keys(hvadErDer).length; i++) {
                  emojis[i] = fruitEmoji[Object.keys(hvadErDer)[i]];
                  totalNum[i] = Object.values(hvadErDer)[i];

                }
                
                //console.log(emojis, totalNum);
                document.getElementById("frugtUI").innerHTML = "";
                var space = " ";
                document.getElementById("frugtUI").innerHTML += "<br>";
                
                for (let i = 0; i < emojis.length; i++) { 

                  if (i == 3) {
                    document.getElementById("frugtUI").innerHTML += "<span>" + totalNum[i] + " " + emojis[i] + "</span>";
                    document.getElementById("frugtUI").innerHTML += "<br><br><br>";
                  }else{
                    document.getElementById("frugtUI").innerHTML += "<span>" + totalNum[i] + " " + emojis[i] + "</span>";
                  }                 
                  
                }

              }, 500)

          }, 1000);

          function checkTrigWord(speech, trigWordArray, utterance) {
            var istriggered = false;
            trigWordArray.forEach(function(element) {
              if (speech.includes(element)) {
                recognition.stop();
                populateVoiceList();
                utterThis = new SpeechSynthesisUtterance(utterance);
                utterThis.voice = voices[index];
                synth.speak(utterThis);
                document.getElementById("responds").innerHTML = utterance;
                //delay 

                istriggered = true;

                //log successful speech in DB
                var currentDate = new Date();
                var dateAndTime = currentDate.getFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate()+' '+currentDate.getHours() + ":" + currentDate.getMinutes() + ":" + currentDate.getSeconds();
                db.ref(document.getElementById('chosenTablet').value + '/successSpeech/' + dateAndTime).set({
                  input: speech,
                  triggerWord: element
                });
                // speechIndex ++;
              }
              
            })
            return istriggered;
          }
          
          console.log("Speech result:" + speechResult);
        }
        recognition.addEventListener("result", onResult);

        
        recognition.onspeechend = function(){
          recognition.stop();
          console.log("on speech end");
        }
        
        recognition.onsoundstart = function(){
          console.log("on sound start");
        }

        utterThis.onend = function(){
              console.log("finished speaking");
              console.log("on test() end");
              test();
            }


        recognition.onend = function (){
          //console.log(utterThis);
          console.log("inside onend now");
          console.log(utterThis, isHome);
          // if (utterThis != undefined || utterThis != null) {
          //   // utterThis.onend = function(){
          //   //   console.log("finished speaking");
          //   //   console.log("on test() end");
          //   //   test();
          //   // }
          // }else 
          if(utterThis == undefined && (isHome == false || isHome == true) ){
            console.log("utterThis is undefined");
            test();
          }
          utterThis = undefined;

          //test();

          // if (utterThis != undefined) {
          //   utterThis.onend = function (){
          //     console.log("finished speaking");
          //     console.log("on test() end");
          //     test();
          //   }
          //   console.log("utterThis is defined");
          //   utterThis = null;
          //   test();
          // }else{
          //   console.log("on end else");
          //   test();
          // }

          if (isHome == false || isHome == undefined) {
            document.getElementById("responds").innerHTML = "Systemet er ikke aktiveret";
            document.getElementById("responds").style.color = "red";
          } 
          
        }
        
        // if (isHome == true && ) {
          
        // }
        

      }


      // function checkTrigWord(speech, trigWordArray, utterance) {
      //   var istriggered = false;
      //   trigWordArray.forEach(function(element) {
      //     if (speech.includes(element)) {
      //       recognition.stop();
      //       populateVoiceList();
      //       utterThis = new SpeechSynthesisUtterance(utterance);
      //       utterThis.voice = voices[index];
      //       synth.speak(utterThis);
      //       document.getElementById("responds").innerHTML = utterance;
      //       //delay 

      //       istriggered = true;

      //       //log successful speech in DB
      //       var currentDate = new Date();
      //       var dateAndTime = currentDate.getFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate()+' '+currentDate.getHours() + ":" + currentDate.getMinutes() + ":" + currentDate.getSeconds();
      //       db.ref(document.getElementById('chosenTablet').value + '/successSpeech/' + dateAndTime).set({
      //         input: speech,
      //         triggerWord: element
      //       });
      //       // speechIndex ++;
      //     }
          
      //   })
      //   return istriggered;
      // }

      function populateVoiceList() {
        if(typeof speechSynthesis === 'undefined') {
          console.log("speechSynthesis === undefined");
          return;
        }

        voices = speechSynthesis.getVoices();

        for(var i = 0; i < voices.length; i++) {
          var option = document.createElement('option');
          option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

          // console.log(voices[i].lang, typeof voices[i].lang);

          if (voices[i].lang == "da-DK" || voices[i].lang == "da_DK") {
            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            document.getElementById("voiceSelect").appendChild(option);
            // utterThis.voice = voices[i];
            index = i;
          }
        }
      }


      
      if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }
      

      

    </script>

    
  </body>
</html>
