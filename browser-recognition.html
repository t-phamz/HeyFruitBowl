<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Browser speech recognition</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
    <!-- <header>
      <h1>Browser speech recognition</h1>
    </header> -->
    <main>
      <select id="voiceSelect" style="display: none;"></select>
      <div id="result">
      </div>
      <p id="responds"></p>
      <p id="message" hidden aria-hidden="true">
        Your browser doesn't support Speech Recognition. Sorry.
      </p>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.2/firebase-database.js"></script>
    
    <script>
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional

      //tjek både frugter og og numoffruits før alle forloops
      
      const firebaseConfig = {
        apiKey: "AIzaSyDGYa_Vr_XnknIdru_LlaYVP116yzxe97A",
        authDomain: "frugtskaal.firebaseapp.com",
        databaseURL: "https://frugtskaal-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "frugtskaal",
        storageBucket: "frugtskaal.appspot.com",
        messagingSenderId: "156136853129",
        appId: "1:156136853129:web:19d39b4d516c5f351c0058",
        measurementId: "G-ZFHZHTPQN5"
      };
      
      firebase.initializeApp(firebaseConfig);

      // Get a reference to the database service
      var db = firebase.database();


      window.onload = test();

      var phrases = [
        'hey frugtskål',
        '32 bananer'
      ];

      var synth = window.speechSynthesis;
      var voices;
      var utterThis;
      var index;
      var repeat;
      var trigger;
      var hasTwoDate = false;
      var noAnswer;
      var chosenFruit;
      var chosenNum;

      populateVoiceList();
      
      function test(){
        var hvadErDer = []
        const button = document.getElementById("button");
        const result = document.getElementById("result");
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        console.log("test() starts");

        //recognition.interimResults = true;
        recognition.interimResults = false;

        recognition.maxAlternatives = 1;
        recognition.lang = 'da-DK';

        recognition.start();

        var speechResult;
        const onResult = event => {
          result.innerHTML = "";
          for (const res of event.results) {
            const text = document.createTextNode(res[0].transcript);
            const p = document.createElement("p");
            if (res.isFinal) {
              p.classList.add("final");
              console.log('Speech has stopped being detected');
              
              // button.click();
            }
            p.appendChild(text);
            result.appendChild(p);
            
            speechResult = event.results[0][0].transcript.toLowerCase();
            console.log(speechResult, typeof speechResult);
            // if (speechResult.includes("frugtskål")) {
            //   console.log("SUCCESS");
            //   //Tree 1 (user started) 
            //   utterThis = new SpeechSynthesisUtterance("hvad kan jeg gøre for dig?");
            //   synth.speak(utterThis);
            // }
          }

          trigWordArrayInital = ['tak', 'Tak']
          if(checkTrigWord(speechResult, trigWordArrayInital, "hvad kan jeg gøre for dig?")){
            trigger = true;
          }
          console.log("trigger is: " + trigger);
          trigWordArrayBuy = [' køb']
          trigWordArrayTake = [ ' tog', ' tage']
          trigWordArrayNG = ['ny', 'gammel', "gamle"]
          trigWordArrayWhat = ["hvad har jeg", "hvad er der"]
          //var hasTwoDate;
          //var tagIsRepeat = false;
         
          //ÆNDRE TRUE TIL TRIGGER



          if (true) {
            var numOfFruits = speechResult.match(/ en| et| én|\d+/g);
            var fruits = speechResult.match(/æbl|banan|pær|appelsin|vindru|vindu|mandarin|fersken|blomm/g);
          
            if (numOfFruits != null) {
              numOfFruits.forEach(function(element, index) {
                if (element == " et" || element == " en" || element == " én") {
                  numOfFruits.splice(index, 1, "1");
                }
              })
            }

            if (fruits != null) {
              fruits.forEach(function(element, index) {
                if (element == "vindu") {
                  fruits.splice(index, 1, "vindru");
                }
              })
            }
            
            console.log("number: ", numOfFruits, typeof numOfFruits);
            console.log("fruits: ", fruits);
            // console.log("du har købt: " + numOfFruits[0] + " " + fruits[0]);
            
            if (checkTrigWord(speechResult, trigWordArrayBuy, "Er det alt du har købt?")){

              var expiryDateArr = {'æbl': 5,'banan': 3,'pær': 3, 'appelsin': 5, 'vindru': 3, 'mandarin': 5, 'fersken': 2, 'blomm': 3};
              //set in i DB
              for (let i = 0; i < fruits.length; i++) {
                var date = new Date();
                //console.log(fruits[i], typeof fruits[i], expiryDateArr[fruits[i]]);
                var expiryDate = expiryDateArr[fruits[i]];
                date.setDate(date.getDate() + expiryDate);

                var dateStr = date.toISOString().slice(0, 10);

                //console.log(expiryDate, date);
                writeData(numOfFruits[i], fruits[i], dateStr);
                console.log(date, typeof date);
                console.log(dateStr, typeof date)
              }

              // const db = firebase.database();
              function writeData(num, fruit, date) {
                db.ref('tablet1/frugter/' + fruit + "/" + date).set({
                  antal: num,
                });
              }

            }
            
            // console.log("HasTwoDate: " + hasTwoDate);

            if (checkTrigWord(speechResult, trigWordArrayTake, " ") && hasTwoDate == false) {
              utterThis = new SpeechSynthesisUtterance("Okay, det er noteret");
              utterThis.voice = voices[index];
              synth.speak(utterThis);
              document.getElementById("responds").innerHTML = "Okay, det er noteret";

              for (let i = 0; i < fruits.length; i++) {
                hasTwoDate = false;
                db.ref().child("tablet1/frugter/" + fruits[i]).get().then((snapshot) => {
                  if (Object.keys(snapshot.val()).length > 1){
                    var utterance = "Har du taget en af de gamle " + fruits[i] + "er eller en af de nye " + fruits[i] + "er";
                    utterThis = new SpeechSynthesisUtterance(utterance);
                    utterThis.voice = voices[index];
                    synth.speak(utterThis);
                    document.getElementById("responds").innerHTML = utterance;
                    hasTwoDate = true;
                    chosenFruit = fruits;
                    chosenNum = numOfFruits;
                  }else{
                    var currentAntal;
                    snapshot.forEach(function(frugtSnapshot) {
                      var date = frugtSnapshot.val();
                      currentAntal = parseInt(date.antal);
                    });
                    
                    db.ref('tablet1/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).update({
                      antal: currentAntal - parseInt(numOfFruits[i])
                    });

                    if (currentAntal <= parseInt(numOfFruits[i])) {
                      db.ref('tablet1/frugter/' + fruits[i] + "/" + Object.keys(snapshot.val())).remove();
                    }
                  }
                });
              }
            }


            if (hasTwoDate && checkTrigWord(speechResult, trigWordArrayNG, "okay, tak")) {
              //console.log("ny eller gammel?");
              var nyDate;
              var gamleDate;
              var currentAntal;
              for (let i = 0; i < chosenFruit.length; i++) {
                db.ref().child("tablet1/frugter/" + chosenFruit[i]).get().then((snapshot) => {
                  dates = Object.keys(snapshot.val()); //string array
                  //console.log(dates, typeof dates);
                  //console.log(dates[0], typeof dates[0]);
                  //console.log(dates[0] > dates[1]); //false
                  
                  if (dates[0] < dates[1]) {
                    gamleDate = dates[0];
                    nyDate = dates[1];
                    console.log("først er mindre end andet");
                    console.log(gamleDate, nyDate);
                  } else {
                    gamleDate = dates[1];
                    nyDate = dates[0];
                    console.log("anden er mindre end første");
                    console.log(gamleDate, nyDate);
                  }

                  if (speechResult.includes("ny")) {
                    db.ref().child("tablet1/frugter/" + chosenFruit[i] + "/" + nyDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref('tablet1/frugter/' + chosenFruit[i] + "/" + nyDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref('tablet1/frugter/' + chosenFruit[i] + "/" + nyDate).remove();
                      }
                    });
                    
                  } else if (speechResult.includes("gamle") || speechResult.includes("gammel")) {
                    db.ref().child("tablet1/frugter/" + chosenFruit[i] + "/" + gamleDate).get().then((snapshot) => {
                      currentAntal = parseInt(Object.values(snapshot.val()));
                      db.ref('tablet1/frugter/' + chosenFruit[i] + "/" + gamleDate).update({
                        antal: currentAntal - parseInt(chosenNum[i])
                      });
                      if (currentAntal <= parseInt(chosenNum[i])) {
                        db.ref('tablet1/frugter/' + chosenFruit[i] + "/" + gamleDate).remove();
                      }
                    });
                  }
                });
                
              }
              // if (speechResult.includes("ny")) {
              //   console.log("ny er taget");
              //   //
              // } else if (speechResult.includes("gamle") || speechResult.includes("gammel")) {
              //   console.log("gammel er taget");
              //   //
              // }
              hasTwoDate = false;  
              noAnswer = false;
            } 

            if (hasTwoDate && noAnswer) {
              var utterance = "Du mangler at svare om det er den nye eller den gamle som er blevet taget";
              utterThis = new SpeechSynthesisUtterance(utterance);
              utterThis.voice = voices[index];
              synth.speak(utterThis);
              document.getElementById("responds").innerHTML = utterance;
            }


            noAnswer = true;
            console.log("HasTwoDate should be true: " + hasTwoDate);

            if (checkTrigWord(speechResult, trigWordArrayWhat, "")) {
              var fruitWithNum = []
              db.ref().child("tablet1/frugter").get().then((snapshot) => {
                //snapshot of each fruit
                // var totalAntal;

                // console.log(snapshot.val());
                var output;
                var Arr = snapshot.val();
                //console.log(Object.keys(Arr).length);

                Object.keys(Arr).forEach(element => {
                  //For each fruit
                  var totalAntal = 0;
                  db.ref().child("tablet1/frugter/" + element).get().then((snapshot) => {
                    //snapshot get date
                    
                    // console.log("date: ", Object.keys(snapshot.val()));
                    for (let i = 0; i < Object.keys(snapshot.val()).length; i++) {
                      var dateArr = Object.keys(snapshot.val());
                      var antal; 
                      // var totalAntal = 0;
                      db.ref().child("tablet1/frugter/" + element + "/" + dateArr[i]).get().then((snapshot) => {
                      //snapshot get antal
                                               
                        antal = parseInt(Object.values(snapshot.val())[0]);
                        totalAntal += antal;
                        console.log(antal, totalAntal);
                        fruitWithNum[element] = totalAntal;
                        hvadErDer = fruitWithNum;
                      });

                    }

                  });
                    
                });
                // for (let i = 0; i < element.length; i++) {
                //   db.ref().child("tablet1/frugter/" + chosenFruit[i]).get().then((snapshot) => {
                //     dates = Object.keys(snapshot.val());
                //   });
                // }
              });
              // for (let index = 0; index < Object.keys(fruitArr).length; index++) {
              //   const element = array[index];
                
              // }
              console.log(hvadErDer);
            }
          }


          function checkTrigWord(speech, trigWordArray, utterance) {
            var istriggered = false;
            trigWordArray.forEach(function(element) {
              if (speech.includes(element)) {
                recognition.stop();
                populateVoiceList();
                utterThis = new SpeechSynthesisUtterance(utterance);
                utterThis.voice = voices[index];
                synth.speak(utterThis);
                document.getElementById("responds").innerHTML = utterance;
                istriggered = true;
              }
              
            })
            return istriggered;
          }
          
          console.log("Speech result:" + speechResult);
        }
        recognition.addEventListener("result", onResult);

        
        recognition.onspeechend = function(){
          recognition.stop();
          console.log("on speech end");
        }
        
        recognition.onsoundstart = function(){
          console.log("on sound start");
        }

        recognition.onend = function (){
          console.log("on test() end");
          repeat = false;
          setTimeout(test, 500);
          //test();
        }

      }

      function populateVoiceList() {
        if(typeof speechSynthesis === 'undefined') {
          console.log("speechSynthesis === undefined");
          return;
        }

        voices = speechSynthesis.getVoices();

        for(var i = 0; i < voices.length; i++) {
          var option = document.createElement('option');
          option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

          // console.log(voices[i].lang, typeof voices[i].lang);

          if (voices[i].lang == "da-DK" || voices[i].lang == "da_DK") {
            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            document.getElementById("voiceSelect").appendChild(option);
            // utterThis.voice = voices[i];
            index = i;
          }
        }
      }


      
      if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }
      

      

    </script>

    
  </body>
</html>
